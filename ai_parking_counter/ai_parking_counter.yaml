# Version: 2.0.0
blueprint:
  name: "ðŸš— AI - Parking Spot Counter"
  description: >
    ðŸ“¦ [Version 2.0.0] Analyzes camera feed with AI to count free and occupied parking
    spaces upon arrival. Supports 1 required + 4 optional zone detection points.
  domain: automation
  source_url: https://github.com/r3mcos3/blueprints/blob/main/ai_parking_counter/ai_parking_counter.yaml
  homeassistant:
    min_version: 2025.12.0

  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ‘¤ PERSON & TRIGGER SETTINGS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    person_entity:
      name: ðŸ‘¤ Person
      description: The person entity to track for zone arrivals.
      selector:
        entity:
          domain: person

    zone_1:
      name: ðŸ˜ï¸ Zone 1 (Required)
      description: Primary zone to monitor for arrival. This detection point is required.
      selector:
        entity:
          domain: zone

    proximity_settings:
      name: ðŸ§­ Proximity Settings
      icon: mdi:compass
      description: Optional proximity sensor to check travel direction.
      collapsed: true
      input:
        proximity_sensor_enabled:
          name: ðŸ§­ Enable Proximity Sensor
          description: Enable proximity direction check. Disable for easier testing.
          default: false
          selector:
            boolean:

        proximity_sensor:
          name: ðŸ§­ Proximity Direction Sensor
          description: Proximity sensor that indicates direction of travel (should have state "towards" when approaching).
          default: sensor.home_nearest_direction_of_travel
          selector:
            entity:
              domain: sensor

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ˜ï¸ OPTIONAL ZONES (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    optional_zones:
      name: ðŸ˜ï¸ Optional Zones (2-5)
      icon: mdi:map-marker-multiple
      description: Configure additional zones that trigger the parking scan.
      collapsed: true
      input:
        zone_2_enabled:
          name: ðŸ˜ï¸ Enable Zone 2
          description: Enable second zone detection point.
          default: false
          selector:
            boolean:

        zone_2:
          name: ðŸ˜ï¸ Zone 2
          description: Second zone to monitor for arrival.
          default: zone.home
          selector:
            entity:
              domain: zone

        zone_3_enabled:
          name: ðŸ˜ï¸ Enable Zone 3
          description: Enable third zone detection point.
          default: false
          selector:
            boolean:

        zone_3:
          name: ðŸ˜ï¸ Zone 3
          description: Third zone to monitor for arrival.
          default: zone.home
          selector:
            entity:
              domain: zone

        zone_4_enabled:
          name: ðŸ˜ï¸ Enable Zone 4
          description: Enable fourth zone detection point.
          default: false
          selector:
            boolean:

        zone_4:
          name: ðŸ˜ï¸ Zone 4
          description: Fourth zone to monitor for arrival.
          default: zone.home
          selector:
            entity:
              domain: zone

        zone_5_enabled:
          name: ðŸ˜ï¸ Enable Zone 5
          description: Enable fifth zone detection point.
          default: false
          selector:
            boolean:

        zone_5:
          name: ðŸ˜ï¸ Zone 5
          description: Fifth zone to monitor for arrival.
          default: zone.home
          selector:
            entity:
              domain: zone

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ¤– AI & CAMERA SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ai_settings:
      name: ðŸ¤– AI & Camera Settings
      icon: mdi:robot
      description: Configure camera and AI for parking analysis.
      collapsed: true
      input:
        camera_entity:
          name: ðŸ“· Camera
          description: Camera to analyze for parking spots (must support snapshot and streaming).
          default: camera.front_door
          selector:
            entity:
              domain: camera

        ai_task_entity:
          name: ðŸ¤– AI Task Entity
          description: AI task entity for image analysis (e.g., ai_task.google_ai_task).
          default: ai_task.google_ai_task
          selector:
            entity:
              domain: ai_task

        ai_instructions:
          name: ðŸ“ AI Instructions
          description: >
            Custom instructions for the AI to analyze parking spots.
            Leave empty to use default instructions. Use {total_spaces} as placeholder.
          default: ""
          selector:
            text:
              multiline: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ…¿ï¸ PARKING SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    parking_settings:
      name: ðŸ…¿ï¸ Parking Settings
      icon: mdi:parking
      description: Configure parking spaces and sensors.
      collapsed: true
      input:
        parking_spaces_total:
          name: ðŸ…¿ï¸ Total Parking Spaces
          description: Total number of parking spaces to count.
          default: 3
          selector:
            number:
              min: 1
              max: 20
              mode: slider

        free_spots_sensor:
          name: ðŸŸ¢ Free Spots Sensor
          description: Input number entity to store the count of free parking spots.
          default: input_number.free_parking_spots
          selector:
            entity:
              domain: input_number

        occupied_spots_sensor:
          name: ðŸ”´ Occupied Spots Sensor
          description: Input number entity to store the count of occupied parking spots.
          default: input_number.occupied_parking_spots
          selector:
            entity:
              domain: input_number

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ“± NOTIFICATION SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    notification_settings:
      name: ðŸ“± Notification Settings
      icon: mdi:bell
      description: Configure Telegram notifications.
      collapsed: true
      input:
        telegram_bot:
          name: ðŸ“± Telegram Bot
          description: Select your Telegram bot. Leave empty to disable notifications.
          default: {}
          selector:
            config_entry:
              integration: telegram_bot

        telegram_message:
          name: ðŸ’¬ Telegram Message
          description: >
            Message to send via Telegram. Use {free_spots} as placeholder.
          default: "There are {free_spots} free parking spots ðŸš— available! ðŸšª"
          selector:
            text:
              multiline: true

        telegram_title:
          name: ðŸ·ï¸ Telegram Title
          description: Optional title for the Telegram notification.
          default: ""
          selector:
            text:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ“¸ SNAPSHOT SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    snapshot_settings:
      name: ðŸ“¸ Snapshot Settings
      icon: mdi:camera
      description: Configure camera snapshot saving.
      collapsed: true
      input:
        snapshot_enabled:
          name: ðŸ“¸ Save Snapshot
          description: Save a camera snapshot when analyzing parking spots.
          default: true
          selector:
            boolean:

        snapshot_path:
          name: ðŸ—‚ï¸ Snapshot Path
          description: File path to save the snapshot.
          default: "/config/www/parking_spot.jpg"
          selector:
            text:

mode: single

# Variables for use in triggers and conditions
trigger_variables:
  _zone_2_enabled: !input zone_2_enabled
  _zone_3_enabled: !input zone_3_enabled
  _zone_4_enabled: !input zone_4_enabled
  _zone_5_enabled: !input zone_5_enabled
  _proximity_enabled: !input proximity_sensor_enabled
  _proximity_sensor: !input proximity_sensor

trigger:
  # Zone 1 (Required - always active)
  - platform: zone
    entity_id: !input person_entity
    zone: !input zone_1
    event: enter
    id: zone_1_enter

  # Zone 2 (Optional)
  - platform: zone
    entity_id: !input person_entity
    zone: !input zone_2
    event: enter
    id: zone_2_enter
    enabled: "{{ _zone_2_enabled }}"

  # Zone 3 (Optional)
  - platform: zone
    entity_id: !input person_entity
    zone: !input zone_3
    event: enter
    id: zone_3_enter
    enabled: "{{ _zone_3_enabled }}"

  # Zone 4 (Optional)
  - platform: zone
    entity_id: !input person_entity
    zone: !input zone_4
    event: enter
    id: zone_4_enter
    enabled: "{{ _zone_4_enabled }}"

  # Zone 5 (Optional)
  - platform: zone
    entity_id: !input person_entity
    zone: !input zone_5
    event: enter
    id: zone_5_enter
    enabled: "{{ _zone_5_enabled }}"

condition:
  - condition: template
    value_template: "{{ not _proximity_enabled or states(_proximity_sensor) == 'towards' }}"

action:
  - variables:
      _camera: !input camera_entity
      _ai_task: !input ai_task_entity
      _total_spaces: !input parking_spaces_total
      _free_sensor: !input free_spots_sensor
      _occupied_sensor: !input occupied_spots_sensor
      _telegram_bot: !input telegram_bot
      _telegram_message: !input telegram_message
      _telegram_title: !input telegram_title
      _snapshot_enabled: !input snapshot_enabled
      _snapshot_path: !input snapshot_path
      _custom_instructions: !input ai_instructions
      _default_instructions: >
        Look at this image of the street in front of my house. There are {{ _total_spaces }}
        parking spaces directly in front of the door. Count how many of these {{ _total_spaces }}
        spaces are FREE (no car parked) and how many are OCCUPIED (car parked).
      _final_instructions: >
        {% if _custom_instructions | trim != "" %}
          {{ _custom_instructions | replace('{total_spaces}', _total_spaces | string) }}
        {% else %}
          {{ _default_instructions }}
        {% endif %}

  - alias: Analyse camera with AI
    action: ai_task.generate_data
    data:
      instructions: "{{ _final_instructions }}"
      structure:
        vrije_plekken:
          selector:
            number:
              min: 0
              max: !input parking_spaces_total
        bezette_plekken:
          selector:
            number:
              min: 0
              max: !input parking_spaces_total
      entity_id: "{{ _ai_task }}"
      task_name: Scan Free Park Spaces
      attachments:
        media_content_id: "media-source://camera/{{ _camera }}"
        media_content_type: application/vnd.apple.mpegurl
        metadata:
          title: "{{ state_attr(_camera, 'friendly_name') | default('Camera') }}"
          thumbnail: "/api/camera_proxy/{{ _camera }}"
          media_class: video
          children_media_class: null
          navigateIds:
            - {}
            - media_content_type: app
              media_content_id: media-source://camera
    response_variable: parking_result

  - alias: Update free parking spots
    action: input_number.set_value
    target:
      entity_id: "{{ _free_sensor }}"
    data:
      value: "{{ parking_result.data.vrije_plekken | int(0) }}"

  - alias: Update occupied parking spots
    action: input_number.set_value
    target:
      entity_id: "{{ _occupied_sensor }}"
    data:
      value: "{{ parking_result.data.bezette_plekken | int(0) }}"

  - alias: Send Telegram notification
    if:
      - condition: template
        value_template: "{{ _telegram_bot != none and _telegram_message | trim != '' }}"
    then:
      - action: telegram_bot.send_message
        data:
          config_entry_id: "{{ _telegram_bot }}"
          title: >-
            {% if _telegram_title | trim != '' %}
              {{ _telegram_title }}
            {% endif %}
          message: >-
            {{ _telegram_message | replace('{free_spots}', states(_free_sensor) | int(0) | string) }}

  - alias: Save camera snapshot
    if:
      - condition: template
        value_template: "{{ _snapshot_enabled | bool }}"
    then:
      - action: camera.snapshot
        target:
          entity_id: "{{ _camera }}"
        data:
          filename: "{{ _snapshot_path }}"
