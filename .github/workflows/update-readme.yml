name: Update README with Blueprints

on:
  push:
    branches:
      - main
    paths:
      - '**/**.yaml'
      - '!.github/**'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Generate blueprint table
        id: generate
        run: |
          echo "Scanning for blueprints..."

          # Start building the table
          TABLE="| Blueprint | Description | Import |
          |-----------|-------------|--------|"

          # Find all blueprint yaml files (excluding .github)
          for dir in */; do
            dir_name="${dir%/}"

            # Skip hidden directories and non-blueprint folders
            [[ "$dir_name" == .* ]] && continue

            # Look for yaml file in the directory
            yaml_file=$(find "$dir_name" -maxdepth 1 -name "*.yaml" -type f | head -1)

            if [[ -n "$yaml_file" ]]; then
              echo "Processing: $yaml_file"

              # Extract blueprint name (with emoji)
              name=$(grep -A1 "^blueprint:" "$yaml_file" | grep "name:" | sed 's/.*name: *"\?\([^"]*\)"\?/\1/' | head -1)

              # If name has unicode escapes, try to get clean name
              if [[ "$name" == *"\\U"* ]] || [[ -z "$name" ]]; then
                # Fallback: use directory name with title case
                name=$(echo "$dir_name" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
              fi

              # Extract description (first line only)
              description=$(grep -A5 "description:" "$yaml_file" | grep -v "description:" | grep -v "^$" | head -1 | sed 's/^ *//' | sed 's/Features:.*//' | cut -c1-80)

              # Clean up description
              description=$(echo "$description" | sed 's/^ *- *//' | sed 's/ *$//')

              # Get emoji from name or assign based on directory
              case "$dir_name" in
                ai_parking*) emoji="ðŸš—" ;;
                ai_weather*) emoji="ðŸŒ¤ï¸" ;;
                doorbell*) emoji="ðŸ””" ;;
                presence*) emoji="ðŸ’¡" ;;
                volume*) emoji="ðŸ”ˆ" ;;
                *) emoji="ðŸ " ;;
              esac

              # Create import URL
              yaml_filename=$(basename "$yaml_file")
              import_url="https://my.home-assistant.io/redirect/blueprint_import/?blueprint_url=https%3A%2F%2Fgithub.com%2Fr3mcos3%2Fblueprints%2Fblob%2Fmain%2F${dir_name}%2F${yaml_filename}"

              # Create display name
              display_name=$(echo "$dir_name" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')

              # Add row to table
              TABLE="$TABLE
          | $emoji **[$display_name]($dir_name/)** | $description | [![Import](https://my.home-assistant.io/badges/blueprint_import.svg)]($import_url) |"
            fi
          done

          # Save table to file
          echo "$TABLE" > /tmp/blueprint_table.md
          cat /tmp/blueprint_table.md

      - name: Update README
        run: |
          # Read the current README
          readme_content=$(cat README.md)

          # Read the generated table
          new_table=$(cat /tmp/blueprint_table.md)

          # Create new README with updated table
          # Find the section between "## âœ¨ Available Blueprints" and the next "##"
          awk -v table="$new_table" '
            /^## âœ¨ Available Blueprints/ {
              print
              print ""
              print "Currently, this repository offers the following blueprints:"
              print ""
              print table
              print ""
              skip=1
              next
            }
            /^## / && skip {
              skip=0
            }
            !skip {
              print
            }
          ' README.md > README.md.new

          mv README.md.new README.md

          echo "Updated README.md:"
          cat README.md

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          git commit -m "ðŸ¤– Auto-update README with blueprint list"
          git push
