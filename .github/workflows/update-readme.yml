name: Update README with Blueprints

on:
  push:
    branches:
      - main
    paths:
      - '**/*.yaml'
      - '!.github/**'

workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup yq
        run: |
          # Download en installeer yq direct
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/bin/yq
          chmod +x /usr/bin/yq

      - name: Generate blueprint table
        id: generate
        run: |
          echo "Scanning for blueprints..."

          # Start building the table
          echo "| Blueprint | Description | Import |" > /tmp/blueprint_table.md
          echo "|-----------|-------------|--------|" >> /tmp/blueprint_table.md

          # Find all blueprint yaml files
          find . -maxdepth 3 -name "*.yaml" -type f ! -path "./.github/*" ! -path "./.git/*" ! -path "./.worktrees/*/.auto-claude/*" -print0 | while IFS= read -r -d '' yaml_file; do
            
            # Skip files inside .auto-claude/specs within worktrees
            if [[ "$yaml_file" == *"/.worktrees/"* ]] && [[ "$(basename $(dirname "$yaml_file"))" == "specs" ]]; then
                continue
            fi

            dir_name=$(dirname "$yaml_file")
            dir_name_basename=$(basename "$dir_name")
            
            # Skip hidden directories
            [[ "$dir_name_basename" == .* ]] && continue

            repo_path_for_url=${yaml_file#./}

            # Use yq to extract name and description
            blueprint_name_raw=$(yq -r '.blueprint.name // ""' "$yaml_file" 2>/dev/null)
            blueprint_desc_raw=$(yq -r '.blueprint.description // ""' "$yaml_file" 2>/dev/null)

            # Fallback for name (Python fix voor nette tekst)
            if [[ -z "$blueprint_name_raw" ]]; then
              display_name=$(python3 -c "import sys; print(sys.stdin.read().strip().replace('_', ' ').title())" <<< "$dir_name_basename")
              emoji="ðŸ "
            else
              display_name="$blueprint_name_raw"
              # Extract emoji based on directory name
              case "$dir_name_basename" in
                ai_parking*) emoji="ðŸš—" ;;
                ai_weather*) emoji="ðŸŒ¤ï¸" ;;
                doorbell*) emoji="ðŸ””" ;;
                presence_lights*) emoji="ðŸ’¡" ;;
                volumecontrol*) emoji="ðŸ”ˆ" ;;
                *) emoji="ðŸ " ;;
              esac
            fi
            
            # Process description
            version="v?"
            short_desc=""

            if [[ -n "$blueprint_desc_raw" ]]; then
              if [[ "$blueprint_desc_raw" =~ ^v([0-9]+\.[0-9]+(\.[0-9]+)?)\s*-\s*(.*)$ ]]; then
                version="v${BASH_REMATCH[1]}"
                short_desc="${BASH_REMATCH[3]}"
              elif [[ "$blueprint_desc_raw" =~ ^v([0-9]+\.[0-9]+(\.[0-9]+)?)$ ]]; then
                version="v${BASH_REMATCH[1]}"
                short_desc="No specific description provided."
              else
                short_desc="$blueprint_desc_raw"
              fi
            else
              short_desc="No description found."
            fi

            # Clean up short description
            short_desc=$(echo "$short_desc" | sed 's/^ *- *//' | sed 's/ *$//' | sed 's/Features:.*//' | sed 's/^ *//')

            # Truncate logic
            max_total_len=80
            current_version_len=${#version}
            remaining_len=$((max_total_len - current_version_len - 3)) 

            if [[ $remaining_len -lt 5 ]]; then
                remaining_len=5
            fi

            if [[ "$short_desc" != "No description found." && "$short_desc" != "No specific description provided." ]]; then
              if [[ ${#short_desc} -gt $remaining_len ]]; then
                short_desc="${short_desc:0:$((remaining_len-3))}..."
              fi
            elif [[ ${#short_desc} -gt $remaining_len ]]; then
                short_desc="${short_desc:0:$((remaining_len-3))}..."
            fi

            formatted_description="$version - $short_desc"
            import_url="https://my.home-assistant.io/redirect/blueprint/?blueprint_url=https://github.com/$GITHUB_REPOSITORY/blob/main/$repo_path_for_url"

            echo "| $emoji **[$display_name]($repo_path_for_url)** | $formatted_description | [![Import](https://my.home-assistant.io/badges/blueprint_import.svg)]($import_url) |" >> /tmp/blueprint_table.md
          done

          cat /tmp/blueprint_table.md

      - name: Update README
        shell: python
        run: |
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  readme_lines = f.readlines()
          except FileNotFoundError:
              readme_lines = []

          try:
              with open('/tmp/blueprint_table.md', 'r', encoding='utf-8') as f:
                  new_table = f.read()
          except FileNotFoundError:
              print("Table file not found!")
              exit(1)

          new_content = []
          in_target_section = False
          section_header_prefix = "## âœ¨ Available Blueprints"
          found_header = False

          for line in readme_lines:
              if line.strip().startswith(section_header_prefix):
                  found_header = True
                  new_content.append(line) 
                  new_content.append("\n")
                  new_content.append("Currently, this repository offers the following blueprints:\n")
                  new_content.append("\n")
                  new_content.append(new_table)
                  new_content.append("\n")
                  in_target_section = True
                  continue
              
              if in_target_section:
                  if line.strip().startswith("## ") and not line.strip().startswith(section_header_prefix):
                      in_target_section = False
                      new_content.append(line)
              else:
                  new_content.append(line)

          if not found_header:
              print("Header not found, appending...")
              new_content.append("\n" + section_header_prefix + "\n")
              new_content.append("\nCurrently, this repository offers the following blueprints:\n\n")
              new_content.append(new_table)
              new_content.append("\n")

          with open('README.md', 'w', encoding='utf-8') as f:
              f.writelines(new_content)
          
          print("README.md updated successfully.")

      - name: Check for changes
        id: check
        run: |
          if git diff --quiet README.md; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH Agent and Key
        if: steps.check.outputs.changed == 'true'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          # Configureren wie de commit maakt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Forceer git om SSH te gebruiken voor de push (in plaats van HTTPS)
          git remote set-url origin git@github.com:$GITHUB_REPOSITORY.git

          git add README.md
          git commit -m "ðŸ¤– Auto-update README with blueprint list and versioned descriptions"
          echo "Pushing changes..."
          git push
