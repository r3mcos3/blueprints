# Version: 1.0.0
blueprint:
  name: "ðŸ”„ Update Notifications"
  description: >
    ðŸ“¦ [Version 1.0.0] Get notified about Home Assistant updates via Telegram!
    Receive notifications when updates are available for core, addons, or integrations.
    Includes actionable buttons to install or skip updates directly from the notification. ðŸš€
  domain: automation
  author: r3mcos3
  source_url: https://github.com/r3mcos3/blueprints/blob/main/update_notifications/update_notifications.yaml
  homeassistant:
    min_version: 2025.12.0

  input:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”„ UPDATE SETTINGS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    update_entities:
      name: ðŸ”„ Update Entities
      description: >
        Select the update entities to monitor. You'll be notified when any of these have an update available.
      selector:
        entity:
          domain: update
          multiple: true

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ“± NOTIFICATION SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    notification_settings:
      name: ðŸ“± Notification Settings
      icon: mdi:bell
      description: Configure Telegram notifications.
      collapsed: true
      input:
        telegram_bot:
          name: ðŸ“± Telegram Bot
          description: Select your Telegram bot for notifications.
          selector:
            config_entry:
              integration: telegram_bot

        send_to_ha:
          name: ðŸ  Send to HA
          description: Also send as a persistent notification in Home Assistant.
          default: false
          selector:
            boolean:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â° REMINDER SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    reminder_settings:
      name: â° Reminder Settings
      icon: mdi:clock-alert
      description: Configure periodic reminders for pending updates.
      collapsed: true
      input:
        reminder_hours:
          name: â° Reminder Interval
          description: >
            Send reminders for pending updates every X hours.
            Set to "None" to disable reminders.
          default: "3"
          selector:
            select:
              options:
                - label: Disabled
                  value: "None"
                - label: Every hour
                  value: "1"
                - label: Every 2 hours
                  value: "2"
                - label: Every 3 hours
                  value: "3"
                - label: Every 6 hours
                  value: "6"
                - label: Every 12 hours
                  value: "12"
                - label: Every 24 hours
                  value: "24"

        only_after:
          name: ðŸŒ… Only After
          description: Only send notifications after this time.
          default: "07:00:00"
          selector:
            time:

        only_before:
          name: ðŸŒ™ Only Before
          description: Only send notifications before this time.
          default: "22:00:00"
          selector:
            time:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ðŸ”§ ADVANCED SETTINGS (COLLAPSED)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    advanced_settings:
      name: ðŸ”§ Advanced Settings
      icon: mdi:cog
      description: Backup and config check options.
      collapsed: true
      input:
        take_backup:
          name: ðŸ’¾ Take Backup
          description: Create a partial backup before updating (if supported).
          default: true
          selector:
            boolean:

        run_config_check:
          name: âœ… Run Config Check
          description: >
            Run the "Check Configuration" addon when a core update is available.
            You must include the core update entity in your monitored entities.
          default: false
          selector:
            boolean:

        changelog_urls:
          name: ðŸ“‹ Custom Changelog URLs
          description: >
            Optional: Provide custom changelog URLs for entities that don't have one.
            Format: {"update.addon_name": "https://github.com/..."}
          default: {}
          selector:
            object:

mode: parallel
max: 100

trigger_variables:
  _reminder_hours: !input reminder_hours
  reminder_hours: "{{ _reminder_hours | default('None') }}"
  reminder_hours_int: "{{ 0 if reminder_hours == 'None' else reminder_hours | int(0) }}"
  run_config_check: !input run_config_check
  update_entities: !input update_entities

trigger:
  # New update available
  - id: new
    platform: state
    entity_id: !input update_entities
    to: "on"

  # Update started
  - id: started
    platform: state
    entity_id: !input update_entities
    attribute: in_progress
    from: false
    to: true

  # Update completed
  - id: done
    platform: state
    entity_id: !input update_entities
    from: "on"
    to: "off"

  # HA startup - check for pending updates
  - id: ha_start
    platform: homeassistant
    event: start

  # Periodic reminder
  - id: reminder
    platform: template
    value_template: >
      {{ states.update | selectattr('state', 'eq', 'on') | list | count > 0
        and reminder_hours_int > 0
        and now().hour % reminder_hours_int == 0
        and now().minute == 0 }}

  # Core config check completed
  - id: core_check
    platform: template
    value_template: >
      {% set ns = namespace(core=none) %}
      {% for u in integration_entities('hassio') | select('in', update_entities)
            if (device_attr(u, 'identifiers') | first)[1] == 'core' %}
          {% set ns.core = u %}
      {% endfor %}
      {% if run_config_check and ns.core is string and expand(ns.core) | first | attr('state') == 'on' %}
        {% for e in expand(integration_entities('hassio')) | selectattr('attributes.device_class', 'eq', 'running')
              if (device_attr(e.entity_id, 'identifiers') | first)[1] == 'core_check_config' %}
            {{ e.state == 'off' and e.last_changed > expand(ns.core) | first | attr('last_changed') }}
        {% endfor %}
      {% else %}
        {{ false }}
      {% endif %}

variables:
  telegram_bot: !input telegram_bot
  send_to_ha: !input send_to_ha
  take_backup: !input take_backup
  _changelog_urls: !input changelog_urls
  changelog_urls: "{{ _changelog_urls if _changelog_urls is mapping else {} }}"
  core_update_entity: >
    {% for u in integration_entities('hassio') | select('search', '^update[.]')
          if (device_attr(u, 'identifiers') | first)[1] == 'core' %}
        {{ u }}
    {% endfor %}
  os_update_entity: >
    {% for u in integration_entities('hassio') | select('search', '^update[.]')
          if (device_attr(u, 'identifiers') | first)[1] == 'OS' %}
        {{ u }}
    {% endfor %}

action:
  choose:
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # UPDATE COMPLETED
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - alias: Update completed
      conditions: "{{ trigger.id == 'done' }}"
      sequence:
        - variables:
            entity_id: "{{ trigger.entity_id }}"
            friendly_name: "{{ state_attr(trigger.entity_id, 'friendly_name') }}"

        - alias: Send completion notification
          action: telegram_bot.send_message
          data:
            config_entry_id: "{{ telegram_bot }}"
            message: "âœ… *{{ friendly_name }}* update completed!"
            parse_mode: markdown

        - alias: Dismiss HA notification if enabled
          if:
            - condition: template
              value_template: "{{ send_to_ha }}"
          then:
            - action: persistent_notification.dismiss
              data:
                notification_id: "update_{{ entity_id[7:] }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # NEW UPDATE AVAILABLE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - alias: New update available
      conditions: "{{ trigger.id == 'new' }}"
      sequence:
        - variables:
            entity_id: "{{ trigger.entity_id }}"
            friendly_name: "{{ state_attr(entity_id, 'friendly_name') }}"
            latest_version: "{{ state_attr(entity_id, 'latest_version') }}"
            installed_version: "{{ state_attr(entity_id, 'installed_version') }}"
            release_summary: "{{ state_attr(entity_id, 'release_summary') | default('', true) }}"
            release_url: >
              {{ state_attr(entity_id, 'release_url')
                | default(changelog_urls[entity_id] | default('', true), true) }}
            ids: "{{ device_attr(entity_id, 'identifiers') | first }}"
            include_core_check: "{{ run_config_check and ids[0] == 'hassio' and ids[1] == 'core' }}"

        - alias: Check time window
          condition: time
          after: !input only_after
          before: !input only_before

        - alias: Send Telegram notification
          action: telegram_bot.send_message
          data:
            config_entry_id: "{{ telegram_bot }}"
            title: "ðŸ”„ Update Available"
            message: >
              ðŸ†• *{{ friendly_name }}*

              ðŸ“¦ New version: `{{ latest_version }}`
              ðŸ“Œ Installed: `{{ installed_version }}`
              {% if release_summary %}

              ðŸ“ {{ release_summary | truncate(200) }}
              {% endif %}
              {% if release_url %}

              ðŸ”— [View Changelog]({{ release_url }})
              {% endif %}
              {% if include_core_check %}

              âš™ï¸ Config check started...
              {% endif %}
            parse_mode: markdown
            inline_keyboard:
              - - text: "âœ… Install"
                  callback_data: "/install_update {{ entity_id }}"
                - text: "â­ï¸ Skip"
                  callback_data: "/skip_update {{ entity_id }}"

        - alias: Send to HA if enabled
          if:
            - condition: template
              value_template: "{{ send_to_ha }}"
          then:
            - action: persistent_notification.create
              data:
                notification_id: "update_{{ entity_id[7:] }}"
                title: "ðŸ”„ {{ friendly_name }}"
                message: >
                  **New version:** {{ latest_version }}

                  **Installed:** {{ installed_version }}
                  {% if release_summary %}

                  {{ release_summary }}
                  {% endif %}
                  {% if release_url %}

                  [View Changelog]({{ release_url }})
                  {% endif %}

        - alias: Start config check if core update
          if:
            - condition: template
              value_template: "{{ include_core_check }}"
          then:
            - action: hassio.addon_start
              data:
                addon: core_check_config

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # UPDATE STARTED
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - alias: Update started
      conditions: "{{ trigger.id == 'started' }}"
      sequence:
        - variables:
            entity_id: "{{ trigger.entity_id }}"
            friendly_name: "{{ state_attr(entity_id, 'friendly_name') }}"

        - alias: Check time window
          condition: time
          after: !input only_after
          before: !input only_before

        - alias: Send updating notification
          action: telegram_bot.send_message
          data:
            config_entry_id: "{{ telegram_bot }}"
            message: "â³ *{{ friendly_name }}* is updating..."
            parse_mode: markdown

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # CONFIG CHECK COMPLETED
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - alias: Core config check completed
      conditions: "{{ trigger.id == 'core_check' }}"
      sequence:
        - variables:
            entity_id: "{{ core_update_entity }}"
            friendly_name: "{{ state_attr(entity_id, 'friendly_name') }}"
            latest_version: "{{ state_attr(entity_id, 'latest_version') }}"

        - alias: Check time window
          condition: time
          after: !input only_after
          before: !input only_before

        - alias: Send config check complete notification
          action: telegram_bot.send_message
          data:
            config_entry_id: "{{ telegram_bot }}"
            message: >
              âœ… *Config check completed* for {{ friendly_name }} {{ latest_version }}

              Check the addon logs for results before updating.
            parse_mode: markdown
            inline_keyboard:
              - - text: "âœ… Install"
                  callback_data: "/install_update {{ entity_id }}"
                - text: "â­ï¸ Skip"
                  callback_data: "/skip_update {{ entity_id }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # HA STARTUP - DISMISS OLD NOTIFICATIONS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - alias: On HA startup, dismiss completed update notifications
      conditions: "{{ trigger.id == 'ha_start' }}"
      sequence:
        - alias: Dismiss core notification if no longer needed
          if:
            - condition: template
              value_template: "{{ core_update_entity != '' and expand(core_update_entity) | first | attr('state') == 'off' }}"
          then:
            - action: persistent_notification.dismiss
              data:
                notification_id: "update_{{ core_update_entity[7:] }}"

        - alias: Dismiss OS notification if no longer needed
          if:
            - condition: template
              value_template: "{{ os_update_entity != '' and expand(os_update_entity) | first | attr('state') == 'off' }}"
          then:
            - action: persistent_notification.dismiss
              data:
                notification_id: "update_{{ os_update_entity[7:] }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # PERIODIC REMINDERS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - alias: Send periodic reminders
      conditions: "{{ trigger.id == 'reminder' }}"
      sequence:
        - variables:
            pending_updates: >
              {{ states.update
                | selectattr('state', 'eq', 'on')
                | rejectattr('attributes.in_progress', 'true')
                | map(attribute='entity_id') | list }}
            update_count: "{{ pending_updates | count }}"

        - alias: Check time window
          condition: time
          after: !input only_after
          before: !input only_before

        - alias: Send reminder if updates pending
          if:
            - condition: template
              value_template: "{{ update_count > 0 }}"
          then:
            - action: telegram_bot.send_message
              data:
                config_entry_id: "{{ telegram_bot }}"
                message: >
                  ðŸ”” *Update Reminder*

                  You have {{ update_count }} pending update{{ 's' if update_count > 1 else '' }}:
                  {% for entity_id in pending_updates %}
                  â€¢ {{ state_attr(entity_id, 'friendly_name') }} â†’ {{ state_attr(entity_id, 'latest_version') }}
                  {% endfor %}
                parse_mode: markdown
