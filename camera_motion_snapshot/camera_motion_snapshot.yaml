blueprint:
  name: ðŸ“¸ Camera Snapshot on Motion to Telegram ðŸ¤–
  description: >
    ðŸ“¦ [Version 1.8.0] Automatically capture a snapshot from your camera ðŸ“· when motion is detected ðŸƒâ€â™‚ï¸ and send it instantly via your Telegram bot ðŸ“¨.

    âœ¨ Features:
    - ðŸ“¸ Instant high-quality snapshot.
    - ðŸƒâ€â™‚ï¸ Triggered by any motion sensor.
    - ðŸ¤– Supports multiple Telegram bots via Config Entry and Chat ID.
    - âœï¸ Fully customizable message caption.
    - â±ï¸ Adjustable timeout (cooldown) between snapshots.
    - ðŸ  Optional presence-based filtering (only when home/away).
  domain: automation
  author: r3mcos3
  source_url: https://github.com/r3mcos3/blueprints/blob/main/camera_motion_snapshot/camera_motion_snapshot.yaml
  input:
    motion_sensor:
      name: ðŸƒâ€â™‚ï¸ Motion Sensor
      description: ðŸ” Select the sensor that should trigger the snapshot.
      selector:
        entity:
          domain: binary_sensor
          device_class: motion
    camera:
      name: ðŸ“· Camera
      description: ðŸ–¼ï¸ Choose the camera to take the snapshot from.
      selector:
        entity:
          domain: camera
    telegram_bot_entry:
      name: ðŸ¤– Telegram Bot Instance
      description: ðŸ”Œ Select the Telegram Bot integration instance to use.
      selector:
        config_entry:
          integration: telegram_bot
    target_chat_id:
      name: ðŸ†” Target Chat ID
      description: âœ‰ï¸ The specific Telegram Chat ID to send the photo to.
      selector:
        text: {}
    message_caption:
      name: âœï¸ Message Caption
      description: ðŸ“ The full message to be sent as a caption with the photo.
      default: "ðŸš¨ Motion detected! ðŸ“¸"
      selector:
        text: {}
    snapshot_path:
      name: ðŸ“‚ Snapshot Path
      description: ðŸ’¾ Local path to save the image (e.g., /config/www/snapshot.jpg).
      default: "/config/www/snapshot_motion.jpg"
      selector:
        text: {}
    motion_delay:
      name: â³ Motion Delay
      description: â±ï¸ Delay between motion detection and snapshot capture (in seconds). Allows camera time to adjust before capturing.
      default: 1
      selector:
        number:
          min: 1
          max: 10
          unit_of_measurement: seconds
          mode: box
    timeout:
      name: â±ï¸ Timeout (Cooldown)
      description: â³ The time to wait after a snapshot before allowing another one (in seconds).
      default: 60
      selector:
        number:
          min: 0
          max: 3600
          unit_of_measurement: seconds
          mode: box
    presence_mode:
      name: ðŸ  Presence Mode
      description: ðŸŽ¯ Choose when to send snapshots based on presence.
      default: always
      selector:
        select:
          options:
            - label: "ðŸŒ Always (ignore presence)"
              value: always
            - label: "ðŸš¶ Only when away from home"
              value: away
            - label: "ðŸ  Only when at home"
              value: home
    person_entity:
      name: ðŸ‘¤ Person Tracker
      description: ðŸ” Select the person entity to track for presence detection. Only used when Presence Mode is not set to 'Always'.
      default: []
      selector:
        entity:
          domain: person

variables:
  target_chat_id_var: !input target_chat_id
  presence_mode_var: !input presence_mode
  person_entity_var: !input person_entity

trigger:
  - platform: state
    entity_id: !input motion_sensor
    from: "off"
    to: "on"

mode: single

condition:
  - condition: template
    value_template: >
      {% set mode = presence_mode_var %}
      {% if mode == 'always' %}
        true
      {% elif mode == 'away' %}
        {{ states(person_entity_var) != 'home' }}
      {% elif mode == 'home' %}
        {{ states(person_entity_var) == 'home' }}
      {% else %}
        true
      {% endif %}

action:
  - delay: !input motion_delay
  - service: camera.snapshot
    target:
      entity_id: !input camera
    data:
      filename: !input snapshot_path
  - delay: "00:00:02"
  - service: telegram_bot.send_photo
    data:
      target: "{{ target_chat_id_var }}"
      file: !input snapshot_path
      caption: !input message_caption
  - delay: !input timeout
